# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   @file           :   tasks/preflight.yml
#   @description    :   preflight tasks
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
---
- name: preflight | check if cluster is installed
  ansible.builtin.stat:
    path: /etc/rancher/k3s/config.yaml
  register: k3s_check_installed
  check_mode: false

- name: preflight | set manifest facts
  ansible.builtin.set_fact:
    k3s_server_manifests_templates: []
    k3s_server_manifests_urls: []
  when: k3s_check_installed.stat.exists

- name: preflight | create the k3s data directory
  ansible.builtin.file:
    path: /var/lib/rancher/k3s
    state: directory
    owner: root
    group: root
    mode: 0755

- name: preflight | deploy audit-policy.yaml
  ansible.builtin.template:
    dest: /var/lib/rancher/k3s/audit-policy.yaml
    group: root
    mode: 0755
    owner: root
    src: k3s/audit-policy.yaml.j2
