---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  # Directories
  ANSIBLE_GALAXY_COLLECTIONS_DIR: "{{.ANSIBLE_DIR}}/.ansible/collections"
  ANSIBLE_GALAXY_ROLES_DIR: "{{.ANSIBLE_DIR}}/.ansible/roles"
  ANSIBLE_LINT_FILE: "{{.ANSIBLE_DIR}}/.ansible-lint"
  ANSIBLE_ROLES_DIR: "{{.ANSIBLE_DIR}}/roles"
  ANSIBLE_DEV_ROLES_DIR: "{{.ANSIBLE_DIR}}/roles-dev"
  # Files
  ANSIBLE_GALAXY_REQUIREMENTS_FILE: "{{.ANSIBLE_DIR}}/requirements.yml"
  ANSIBLE_PIP_REQUIREMENTS_FILE: "{{.ANSIBLE_DIR}}/requirements.txt"

env:
  ANSIBLE_CONFIG: "{{.ANSIBLE_DIR}}/ansible.cfg"

tasks:

  # task ansible:deps
  deps:
    desc: Install/Upgrade Ansible dependencies
    deps:
      - :workstation:venv
    vars:
      force: '{{.force | default "true"}}'
    cmds:
      - |
        {{.VIRTUAL_ENV}}/bin/python3 -m pip install \
          --upgrade \
          --requirement {{.ANSIBLE_PIP_REQUIREMENTS_FILE}}
      - |
        {{.VIRTUAL_ENV}}/bin/ansible-galaxy role install \
          {{- if .force }}--force \{{ end }}
          --roles-path {{.ANSIBLE_GALAXY_ROLES_DIR}} \
          --role-file {{.ANSIBLE_GALAXY_REQUIREMENTS_FILE}}
      - |
        {{.VIRTUAL_ENV}}/bin/ansible-galaxy collection install \
          --collections-path {{.ANSIBLE_GALAXY_COLLECTIONS_DIR}} \
          --requirements-file {{.ANSIBLE_GALAXY_REQUIREMENTS_FILE}} \
          --upgrade
    sources:
      - "{{.ANSIBLE_GALAXY_REQUIREMENTS_FILE}}"
      - "{{.ANSIBLE_PIP_REQUIREMENTS_FILE}}"
    generates:
      - "{{.VIRTUAL_ENV}}/bin/ansible"
      - "{{.VIRTUAL_ENV}}/bin/ansible-galaxy"
    preconditions:
      - { msg: "Missing ansible-galaxy requirements file", sh: "test -f {{.ANSIBLE_GALAXY_REQUIREMENTS_FILE}}" }
      - { msg: "Missing Ansible pip requirements file", sh: "test -f {{.ANSIBLE_PIP_REQUIREMENTS_FILE}}" }

  # task ansible:role-template name=<role_name> [path=<destination_path>] [skel_path=<source_path>] [force=true]
  role-template:
    desc: Create ansible-role from skeleton template
    vars:
      role_path: "{{ .path | default .ANSIBLE_DEV_ROLES_DIR }}"
      default_skeleton_path: "{{.ANSIBLE_ROLES_DIR}}/ansible-role-skeleton"
      skeleton_path: '{{ .skel_path | default .default_skeleton_path }}'
    cmds:
      - |
        {{.VIRTUAL_ENV}}/bin/ansible-galaxy role init \
          --init-path {{.role_path}} \
          --offline \
          --role-skeleton {{ .skeleton_path }} \
          {{- if .force }}--force \{{ end }}
          {{ .name }}
    requires:
      vars:
        - name
    preconditions:
      - { msg: "ansible-galaxy not in $PATH", sh: "command -v ansible-galaxy" }

  # task ansible:lint
  lint:
    desc: Lint Ansible
    deps:
      - deps
    cmds:
      - |
        {{.VIRTUAL_ENV}}/bin/ansible-lint \
          --config-file {{.ANSIBLE_LINT_FILE}} \
          {{.ANSIBLE_DIR}}/**/*.yaml
    preconditions:
      - { msg: "ansible-lint not in $PATH", sh: "command -v ansible-lint" }
      - { msg: "Missing ansible lint file", sh: "test -f {{.ANSIBLE_LINT_FILE}}" }
