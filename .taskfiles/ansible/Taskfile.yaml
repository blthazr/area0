---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  # Directories
  ANSIBLE_GALAXY_COLLECTIONS_DIR: "{{.ANSIBLE_DIR}}/.ansible/collections"
  ANSIBLE_GALAXY_ROLES_DIR: "{{.ANSIBLE_DIR}}/.ansible/roles"
  ANSIBLE_ROLES_DIR: "{{.ANSIBLE_DIR}}/roles"
  ANSIBLE_DEV_ROLES_DIR: "{{.ANSIBLE_DIR}}/roles-dev"
  # Files
  ANSIBLE_GALAXY_REQUIREMENTS_FILE: "{{.ANSIBLE_DIR}}/requirements.yml"

tasks:

  # task ansible:deps
  deps:
    desc: Install/Upgrade Ansible dependencies
    cmds:
      - ansible-galaxy collection install --requirements-file {{.ANSIBLE_GALAXY_REQUIREMENTS_FILE}} --collections-path {{.ANSIBLE_GALAXY_COLLECTIONS_DIR}} --force
      - ansible-galaxy role install --role-file {{.ANSIBLE_GALAXY_REQUIREMENTS_FILE}} --roles-path {{.ANSIBLE_GALAXY_ROLES_DIR}} --force
    preconditions:
      - { msg: "ansible-galaxy not in $PATH", sh: "command -v ansible-galaxy" }
      - { msg: "Missing ansible-galaxy requirements file", sh: "test -f {{.ANSIBLE_GALAXY_REQUIREMENTS_FILE}}" }

  # task ansible:role-template name=<role_name> [path=<destination_path>] [skel_path=<source_path>] [force=true]
  role-template:
    desc: Create ansible-role from skeleton template
    vars:
      role_path: "{{ .path | default .ANSIBLE_DEV_ROLES_DIR }}"
      default_skeleton_path: "{{.ANSIBLE_ROLES_DIR}}/ansible-role-skeleton"
      skeleton_path: '{{ .skel_path | default .default_skeleton_path }}'
    cmds:
      - |
        ansible-galaxy role init \
          --init-path {{.role_path}} \
          --offline \
          --role-skeleton {{ .skeleton_path }} \
          {{- if .force }}--force \{{ end }}
          {{ .name }}
    requires:
      vars:
        - name
    preconditions:
      - { msg: "ansible-galaxy not in $PATH", sh: "command -v ansible-galaxy" }
