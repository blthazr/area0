---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  # Directories
  TALOS_DIR: "{{.INFRASTRUCTURE_DIR}}/talos"
  TALOSCONFIG_DIR: "{{.TALOS_DIR}}/clusterconfig"
  # Files
  HELMFILE_FILE: "{{.TALOS_DIR}}/apps/helmfile.yaml"
  TALHELPER_CONFIG_FILE: "{{.TALOS_DIR}}/talconfig.yaml"
  TALHELPER_ENV_FILE: "{{.TALOS_DIR}}/talenv.sops.yaml"
  TALHELPER_SECRET_FILE: "{{.TALOS_DIR}}/talsecret.sops.yaml"
  TALOSCONFIG_FILE: "{{.TALOSCONFIG_DIR}}/talosconfig"

env:
  TALOSCONFIG: "{{.TALOSCONFIG_FILE}}"

tasks:

  # task talos:generate-clusterconfig
  generate-clusterconfig:
    desc: Generate the Talos configs
    dir: "{{.TALOS_DIR}}"
    cmds:
      - |
        talhelper genconfig \
          --config-file {{.TALHELPER_CONFIG_FILE}} \
          --env-file {{.TALHELPER_ENV_FILE}} \
          --out-dir {{.TALOSCONFIG_DIR}} \
          --secret-file {{.TALHELPER_SECRET_FILE}}
    preconditions:
      - { msg: "talhelper not in $PATH", sh: "command -v talhelper" }
      - { msg: "talosctl not in $PATH", sh: "command -v talosctl" }
      - { msg: "Missing talhelper config file", sh: "test -f {{.TALHELPER_CONFIG_FILE}}" }
      - { msg: "Missing talhelper env file", sh: "test -f {{.TALHELPER_ENV_FILE}}" }
      - { msg: "Missing talhelper secret file", sh: "test -f {{.TALHELPER_SECRET_FILE}}" }

  # task talos:kubeconfig
  kubeconfig:
    desc: Fetch kubeconfig from Talos controller
    vars:
      cluster_name:
        sh: yq '.context' {{.TALOSCONFIG_FILE}}
      controller:
        sh: |
          talosctl config info --output json | jq --raw-output '.endpoints[]' | shuf -n 1
      kubeconfig_dir:
        sh: dirname {{.KUBECONFIG_FILE}}
      talos_cluster: '{{.talos_cluster | default .cluster_name}}'
    cmds:
      - |
        talosctl kubeconfig \
            --nodes {{.controller}} \
            --force \
            --force-context-name {{.talos_cluster}} \
            {{.kubeconfig_dir}}
    preconditions:
      - { msg: "jq not in $PATH", sh: "command -v jq" }
      - { msg: "talosctl not in $PATH", sh: "command -v talosctl" }
      - { msg: "yq not in $PATH", sh: "command -v yq" }
      - { msg: "Missing talosconfig file", sh: "test -f {{.TALOSCONFIG_FILE}}" }
      - { msg: "Missing Talos cluster configuration", sh: "talosctl config info >/dev/null 2>&1" }

  # task talos:diff hostname=<node_name>
  diff:
    desc: Diff the Talos machineConfig on a node
    summary: |
      hostname: Hostname of the node (required)
    deps:
      - generate-clusterconfig
    cmds:
      - task: .apply-machineconfig
        vars:
          extra_flags: --dry-run
          node: "{{.hostname}}"
    requires:
      vars:
        - hostname

  # task talos:apply hostname=<node_name> [mode=reboot]
  apply:
    desc: Apply the Talos machineConfig on a node
    summary: |
      hostname: Hostname of the node (required)
    deps:
      - generate-clusterconfig
    vars:
      mode: '{{.mode | default "no-reboot"}}'
    cmds:
      - task: .apply-machineconfig
        vars:
          extra_flags: "--mode {{.mode}}"
          node: "{{.hostname}}"
    requires:
      vars:
        - hostname
    preconditions:
      - { msg: "Value `{{.mode}}` in variable mode is invalid", sh: "case {{.mode}} in auto|interactive|no-reboot|reboot|staged|try) exit 0 ;; *) exit 1 ;; esac" }

  .apply-machineconfig:
    internal: true
    vars:
      node_ip_address:
        sh: |
          yq '.nodes[] | select(.hostname == "{{.node}}") | .ipAddress' {{.TALHELPER_CONFIG_FILE}}
    cmds:
      - |
        talhelper gencommand apply \
            --config-file {{.TALHELPER_CONFIG_FILE}} \
            --env-file {{.TALHELPER_ENV_FILE}} \
            {{- if .extra_flags }}--extra-flags="{{.extra_flags}}" \{{ end }}
            {{- if .node_ip_address }}--node {{.node_ip_address}} \{{ end }}
            --out-dir {{.TALOSCONFIG_DIR}} \
        | bash
    requires:
      vars:
        - node
    preconditions:
      - { msg: "talhelper not in $PATH", sh: "command -v talhelper" }
      - { msg: "talosctl not in $PATH", sh: "command -v talosctl" }
      - { msg: "yq not in $PATH", sh: "command -v yq" }
      - { msg: "Missing talhelper config file", sh: "test -f {{.TALHELPER_CONFIG_FILE}}" }
      - { msg: "Missing talhelper env file", sh: "test -f {{.TALHELPER_ENV_FILE}}" }
      - { msg: "Missing talosconfig file", sh: "test -f {{.TALOSCONFIG_FILE}}" }
      - { msg: "Missing Talos machineconfig", sh: "talosctl --nodes {{.node_ip_address}} get machineconfig >/dev/null 2>&1" }
      - { msg: "IP Address for node {{.node}} not found in {{.TALHELPER_CONFIG_FILE}}", sh: "[ '{{.node_ip_address}}' != '<no value>' ] || [ -z '{{.node}}' ]" }
      - { msg: "Missing Talos cluster configuration", sh: "talosctl config info >/dev/null 2>&1" }
