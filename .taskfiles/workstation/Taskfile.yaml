---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  # Directories
  WORKSTATION_RESOURCES_DIR: "{{.ROOT_DIR}}/.taskfiles/workstation/resources"
  # Files
  BREWFILE_FILE: "{{.WORKSTATION_RESOURCES_DIR}}/Brewfile"

tasks:

  # task workstation:direnv
  direnv:
    desc: Run direnv hooks
    cmds:
      - direnv allow .
    preconditions:
      - { msg: "direnv not in $PATH", sh: "command -v direnv" }
    status:
      - "[[ $(direnv status --json | jq '.state.foundRC.allowed') == 0 ]]"
      - "[[ $(direnv status --json | jq '.state.loadedRC.allowed') == 0 ]]"

  # task workstation:brew
  brew:
    desc: Install workstation dependencies with Brew
    cmds:
      - brew bundle --file {{.BREWFILE_FILE}}
    preconditions:
      - { msg: "brew not in $PATH", sh: "command -v brew" }
      - { msg: "Missing Brewfile file", sh: "test -f {{.BREWFILE_FILE}}" }

  # task workstation:venv
  venv:
    desc: Set up python virtual environment
    cmds:
      - "{{.PYTHON_BIN}} -m venv {{.VIRTUAL_ENV}}"
      - "{{.VIRTUAL_ENV}}/bin/python3 -m pip install --upgrade pip setuptools wheel"
      - "{{.VIRTUAL_ENV}}/bin/python3 -m pip install --upgrade --requirement {{.PIP_REQUIREMENTS_FILE}}"
    sources:
      - "{{.PIP_REQUIREMENTS_FILE}}"
    generates:
      - "{{.VIRTUAL_ENV}}/pyvenv.cfg"
    preconditions:
      - { msg: "Missing Pip requirements file", sh: "test -f {{.PIP_REQUIREMENTS_FILE}}" }
