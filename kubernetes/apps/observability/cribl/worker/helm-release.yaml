---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app cribl-worker
spec:
  chart:
    spec:
      chart: logstream-workergroup
      version: 4.2.1
      sourceRef:
        kind: HelmRepository
        name: cribl-charts
        namespace: flux-system
  install:
    remediation:
      retries: 3
  interval: 30m
  maxHistory: 2
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    config:
      host: cribl-leader-internal
      token: "${SECRET_CRIBL_LEADER_TOKEN}"
    criblImage:
      repository: cribl/cribl
      tag: 4.2.1
    resources: {}
    service:
      annotations:
        metallb.universe.tf/allow-shared-ip: cribl-worker
      loadBalancerIP: "${SVC_CRIBL_WORKER_ADDRESS}"
      ports:
        - name: splunk-hec
          port: 8088
          protocol: TCP
        - name: splunk-otel
          port: 9090
          protocol: TCP
        - name: syslog-tcp
          port: 9514
          protocol: TCP
        - name: syslog-udp
          port: 9514
          protocol: UDP
        - name: syslog-unifi
          port: 9520
          protocol: UDP
        - name: syslog-dsm
          port: 9521
          protocol: UDP
      type: LoadBalancer
