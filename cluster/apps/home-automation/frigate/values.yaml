---
nameOverride: &app frigate
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: feature.node.kubernetes.io/custom-coral-tpu
              operator: In
              values: ["true"]
env:
  LIBVA_DRIVER_NAME: i965
  TZ: "${CLUSTER_TIME_ZONE}"
envFrom:
  - secretRef:
      name: frigate-secrets
image:
  repository: docker.io/blakeblackshear/frigate
  tag: 0.11.1
ingress:
  main:
    enabled: true
    hosts:
      - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
        paths:
          - path: /
            pathType: Prefix
    ingressClassName: nginx
    tls:
      - hosts:
          - *host
persistence:
  cache:
    enabled: true
    medium: Memory
    mountPath: /dev/shm
    sizeLimit: 512Mi
    type: emptyDir
  config:
    enabled: true
    mountPath: /config/config.yml
    name: frigate-config
    readOnly: true
    subPath: frigate-config.yaml
    type: configMap
  data:
    enabled: true
    existingClaim: frigate-data-v1
  media:
    enabled: true
    mountPath: /media
    path: "${NAS_NFS_PATH}/apps/frigate"
    server: "${NAS_ADDRESS}"
    type: nfs
  usb:
    enabled: true
    hostPath: /dev/bus/usb
    type: hostPath
podAnnotations:
  configmap.reloader.stakater.com/reload: frigate-config
  secret.reloader.stakater.com/reload: frigate-secrets
probes:
  liveness: &probe
    custom: true
    enabled: true
    spec:
      failureThreshold: 3
      httpGet:
        path: /api/version
        port: &port 5000
      initialDelaySeconds: 0
      periodSeconds: 10
      timeoutSeconds: 1
  readiness: *probe
  startup:
    enabled: true
    custom: true
    spec:
      httpGet:
        path: /api/version
        port: *port
      failureThreshold: 30
      periodSeconds: 10
resources:
  limits:
    gpu.intel.com/i915: 1
  requests:
    gpu.intel.com/i915: 1
securityContext:
  privileged: true
service:
  main:
    externalTrafficPolicy: Local
    loadBalancerIP: "${SVC_FRIGATE_ADDRESS}"
    ports:
      http:
        port: *port
    type: LoadBalancer
