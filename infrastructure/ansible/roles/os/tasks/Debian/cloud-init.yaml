# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   @file           :   tasks/Debian/cloud-init.yaml
#   @description    :   Debian cloud-init tasks
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
---
- name: "{{ ansible_os_family }} | cloud-init | disable"
  block:
    - name: "{{ ansible_os_family }} | cloud-init | disable cloud-init"
      ansible.builtin.file:
        access_time: preserve
        dest: /etc/cloud/cloud-init.disabled
        mode: "0775"
        modification_time: preserve
        owner: root
        state: touch

    - name: "{{ ansible_os_family }} | cloud-init | uninstall cloud-init"
      ansible.builtin.apt:
        autoremove: true
        name: "cloud-init"
        state: absent

    - name: "{{ ansible_os_family }} | cloud-init | remove service"
      ansible.builtin.service:
        enabled: false
        name: cloud-init
        state: stopped

    - name: "{{ ansible_os_family }} | cloud-init | remove cloud-init network configuration"
      ansible.builtin.file:
        path: /etc/network/interfaces.d/50-cloud-init
        state: absent

    - name: "{{ ansible_os_family }} | packages | remove cloud-init files"
      ansible.builtin.file:
        path: "{{ cloud_init_files }}"
        state: absent
      loop:
        - "/etc/cloud"
        - "/var/lib/cloud"
      loop_control:
        loop_var: cloud_init_files
  when:
    - os_packages.debian.apt_remove is defined
    - "'cloud-init' in os_packages.debian.apt_remove"
